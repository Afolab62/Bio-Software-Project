{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Stage Experiment: WT Protein + Plasmid Validation</h2>
    <p class="muted">Note: validation will fail if the plasmid does not encode the selected UniProt WT protein.</p>
    <details class="muted" style="margin-top: 8px;">
      <summary>How validation works</summary>
      <div style="margin-top: 6px;">
        We translate the circular plasmid in all six frames, then search for the WT protein using
        exact matching, fuzzy identity fallback, and a final local alignment step for indels.
      </div>
    </details>
    <form method="post" enctype="multipart/form-data">
      <label for="accession">UniProt Accession</label>
      <input type="text" id="accession" name="accession" required value="{{ accession or '' }}">

      <label for="plasmid_fasta">Plasmid FASTA (paste)</label>
      <div class="muted" style="margin-bottom: 6px;">FASTA should begin with a header line starting with “&gt;”.</div>
      <textarea id="plasmid_fasta" name="plasmid_fasta" rows="8">{{ plasmid_fasta or '' }}</textarea>

      <button type="button" id="load-example">Load Example FASTA</button>

      <label for="plasmid_file">Or upload FASTA file</label>
      <input type="file" id="plasmid_file" name="plasmid_file" accept=".fa,.fasta,.txt">

      <label>
        <input type="checkbox" name="fetch_features" {% if fetch_features %}checked{% endif %}>
        Fetch UniProt feature table
      </label>

      <button type="submit" id="validate-btn">Validate</button>
      <span id="loading-indicator" class="muted" style="margin-left: 8px; display: none;">Validating…</span>
      <button type="button" id="reset-form" style="margin-left: 8px;">Reset</button>
      <div class="muted" style="margin-top: 6px;">Note: alignment fallback can be slower on very long sequences.</div>
    </form>
  </div>

  {% if result %}
  <div class="card">
    <h3>Result</h3>
    {% if result.error %}
      <span class="badge err">Not valid</span>
      <p class="error">{{ result.error }}</p>
    {% else %}
      <span class="badge ok">Valid</span>
      <p class="ok">Validation complete.</p>
      <h4>Validation</h4>
      <button type="button" id="copy-validation" style="margin-bottom: 8px;">Copy JSON</button>
      <button type="button" id="download-validation" style="margin-left: 8px; margin-bottom: 8px;">Download JSON</button>
      <pre id="validation-json">{{ result.validation | tojson(indent=2) }}</pre>
      <h4>UniProt Features</h4>
      <button type="button" id="download-features" style="margin-bottom: 8px;">Download JSON</button>
      <pre id="features-json">{{ result.features | tojson(indent=2) }}</pre>
    {% endif %}
  </div>
  {% endif %}

  <script>
    document.querySelector("form")?.addEventListener("submit", () => {
      const btn = document.getElementById("validate-btn");
      const loading = document.getElementById("loading-indicator");
      if (btn) btn.setAttribute("disabled", "disabled");
      if (loading) loading.style.display = "inline";
    });

    document.getElementById("load-example")?.addEventListener("click", async () => {
      try {
        const resp = await fetch("/staging/example");
        const data = await resp.json();
        if (data.fasta) {
          document.getElementById("plasmid_fasta").value = data.fasta;
        }
      } catch (e) {
        // no-op: example is optional
      }
    });

    document.getElementById("copy-validation")?.addEventListener("click", async () => {
      const el = document.getElementById("validation-json");
      if (!el) return;
      try {
        await navigator.clipboard.writeText(el.textContent);
      } catch (e) {
        // no-op: clipboard may be blocked
      }
    });

    document.getElementById("download-validation")?.addEventListener("click", () => {
      const el = document.getElementById("validation-json");
      if (!el) return;
      const blob = new Blob([el.textContent], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "validation.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("download-features")?.addEventListener("click", () => {
      const el = document.getElementById("features-json");
      if (!el) return;
      const blob = new Blob([el.textContent], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "uniprot_features.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("reset-form")?.addEventListener("click", () => {
      document.querySelector("form")?.reset();
      const fasta = document.getElementById("plasmid_fasta");
      if (fasta) fasta.value = \"\";
    });
  </script>
{% endblock %}
